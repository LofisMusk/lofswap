name: Deploy Node-CLI to Server 2

on:
  push:
    branches: [ main ]
    # paths: ['node-cli/**', 'blockchain-core/**']   # odkomentuj, jeśli chcesz uruchamiać tylko przy zmianach w tych folderach

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."   # jeśli masz workspace, dostosuj

      - name: Build Release
        run: |
          cargo build -r -p node-cli
          mkdir -p artifacts
          cp target/release/node-cli artifacts/
          # jeśli masz dodatkowe pliki (config.toml, .env.example itp.)
          # cp config/* artifacts/
          cd artifacts
          zip -r ../node-cli.zip .

      - name: Upload artifact for debugging (opcjonalnie)
        uses: actions/upload-artifact@v4
        with:
          name: node-cli-binary
          path: node-cli.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: node-cli-binary
          path: .

      - name: Setup SSH key & known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Najbezpieczniejszy sposób – printf gwarantuje trailing newline
          printf '%s\n' "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key

          chmod 600 ~/.ssh/deploy_key

          # Debug – sprawdzamy format pliku (bezpiecznie, nie pokazuje całego klucza)
          echo "Key file size: $(stat -c %s ~/.ssh/deploy_key) bytes"
          head -n 3 ~/.ssh/deploy_key | sed 's/./*/g'   # maskowane pierwsze linie
          tail -n 3 ~/.ssh/deploy_key | sed 's/./*/g'   # maskowane ostatnie linie

          # Dodajemy host do known_hosts (mniej ostrzeżeń MITM)
          ssh-keyscan -H ${{ secrets.SSH_HOST2 }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Server 2 (SCP + extract + restart)
        run: |
          echo "Deploying to ${{ secrets.SSH_HOST2 }} as ${{ secrets.SSH_USER }}"

          # Kopiowanie z verbose
          scp -v \
            -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            node-cli.zip ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST2 }}:${{ secrets.DEPLOY_PATH }}/

          # Zdalne wykonanie komend
          ssh -v \
            -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST2 }} << 'EOF'
              echo "Połączono z serwerem"
              cd ${{ secrets.DEPLOY_PATH }} || { echo "Błąd: katalog nie istnieje"; exit 1; }
              unzip -o node-cli.zip || { echo "Błąd unzip"; exit 1; }
              rm -f node-cli.zip
              chmod +x node-cli
              sudo systemctl daemon-reload
              sudo systemctl restart node-cli || { echo "Restart nieudany"; exit 1; }
              sleep 2
              sudo systemctl status node-cli --no-pager || true
              echo "Deploy zakończony"
          EOF
