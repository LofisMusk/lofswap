name: Deploy Node-CLI to Server 2

on:
  push:
    branches: [ main ]
    # paths: ['node-cli/**', 'blockchain-core/**']   # odkomentuj, jeśli chcesz uruchamiać tylko przy zmianach w tych folderach

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "."   # jeśli masz workspace, dostosuj

      - name: Build Release
        run: |
          cargo build -r -p node-cli
          cargo build -r -p explorer-api
          mkdir -p artifacts/explorer-api
          cp target/release/node-cli artifacts/
          cp target/release/explorer-api artifacts/explorer-api/
          # jeśli masz dodatkowe pliki (config.toml, .env.example itp.)
          # cp config/* artifacts/
          cd artifacts
          zip -r ../node-cli.zip .

      - name: Upload artifact for debugging (opcjonalnie)
        uses: actions/upload-artifact@v4
        with:
          name: node-cli-binary
          path: node-cli.zip
          retention-days: 1

  deploy:
    runs-on: ubuntu-22.04
    needs: build

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: node-cli-binary
          path: .

      - name: Prepare artifact file for scp
        run: |
          # actions/download-artifact extracts into ./node-cli-binary by artifact name.
          # Move the zip to workspace root so scp can find ./node-cli.zip
          set -e
          echo "Workspace contents before move:"
          ls -la

          if [ -d "./node-cli-binary" ]; then
            echo "Found ./node-cli-binary, listing:"
            ls -la node-cli-binary || true
            # Move any zip found in that folder to workspace root
            mv node-cli-binary/*.zip ./ || true
          fi

          # fallback: find any node-cli*.zip and copy to ./node-cli.zip
          if [ ! -f "./node-cli.zip" ]; then
            found=$(find . -maxdepth 3 -type f -name 'node-cli*.zip' | head -n1 || true)
            if [ -n "$found" ]; then
              echo "Found zip at: $found — copying to ./node-cli.zip"
              cp "$found" ./node-cli.zip
            fi
          fi

          echo "Workspace contents after move:"
          ls -la

      - name: Setup SSH key & known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Najbezpieczniejszy sposób – printf gwarantuje trailing newline
          printf '%s\n' "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key

          chmod 600 ~/.ssh/deploy_key

          # Debug – sprawdzamy format pliku (bezpiecznie, nie pokazuje całego klucza)
          echo "Key file size: $(stat -c %s ~/.ssh/deploy_key) bytes"
          head -n 3 ~/.ssh/deploy_key | sed 's/./*/g'   # maskowane pierwsze linie
          tail -n 3 ~/.ssh/deploy_key | sed 's/./*/g'   # maskowane ostatnie linie

          # Dodajemy host do known_hosts (mniej ostrzeżeń MITM)
          ssh-keyscan -H ${{ secrets.SSH_HOST2 }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Server 2 (prepare remote dir, SCP + extract + restart)
        run: |
          echo "Deploying to ${{ secrets.SSH_HOST2 }} as ${{ secrets.SSH_USER }}"

          # Ensure remote directory exists and show info (helps diagnose 'Is a directory' errors)
          ssh -v \
            -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST2 }} "mkdir -p '${{ secrets.DEPLOY_PATH }}' && echo 'Remote directory info:' && ls -ld '${{ secrets.DEPLOY_PATH }}' || true"

          # Kopiowanie z explicit filename to avoid ambiguity
          scp -v \
            -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            "./node-cli.zip" ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST2 }}:"${{ secrets.DEPLOY_PATH }}/node-cli.zip"

          # Zdalne wykonanie komend: unzip, restart
          ssh -v \
            -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST2 }} << 'EOF'
              echo "Połączono z serwerem"
              cd ${{ secrets.DEPLOY_PATH }} || { echo "Błąd: katalog nie istnieje"; exit 1; }
              unzip -o node-cli.zip || { echo "Błąd unzip"; exit 1; }
              rm -f node-cli.zip
              chmod +x node-cli
              chmod +x explorer-api/explorer-api || true
              sudo systemctl daemon-reload
              sudo systemctl restart node-cli || { echo "Restart nieudany"; exit 1; }
              sudo systemctl restart explorer-api || { echo "Restart explorer-api nieudany"; exit 1; }
              sleep 2
              sudo systemctl status node-cli --no-pager || true
              sudo systemctl status explorer-api --no-pager || true
              echo "Deploy zakończony"
          EOF
